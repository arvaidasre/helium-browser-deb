name: Auto Build and Release (Self-hosted)

on:
  workflow_dispatch:
    inputs:
      force_build:
        description: "Force build even if release exists"
        type: boolean
        default: false
  schedule:
    - cron: "0 */3 * * *"

permissions:
  contents: write
  pages: write
  id-token: write

env:
  UPSTREAM_REPO: imputnet/helium-linux

jobs:
  check-and-build:
    runs-on: self-hosted
    outputs:
      new_version: ${{ steps.check.outputs.new_version }}
      upstream_tag: ${{ steps.check.outputs.upstream_tag }}
      is_prerelease: ${{ steps.check.outputs.is_prerelease }}
      should_build: ${{ steps.check.outputs.should_build }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify check dependencies
        run: |
          set -euo pipefail
          for cmd in curl jq git; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
              echo "Missing dependency: $cmd"
              exit 1
            fi
          done

      - name: Check for new upstream releases
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FORCE_BUILD: ${{ github.event.inputs.force_build }}
        run: |
          set -euo pipefail

          echo "Checking upstream repository: $UPSTREAM_REPO"

          RELEASES_JSON=$(curl -fsSL -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/releases" || echo "[]")

          RELEASE_JSON=$(echo "$RELEASES_JSON" | jq 'sort_by(.created_at) | last // {}')
          RELEASE_TAG=$(echo "$RELEASE_JSON" | jq -r '.tag_name // ""')

          if [[ -z "$RELEASE_TAG" || "$RELEASE_TAG" == "null" ]]; then
            echo "No releases found upstream"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Latest upstream release: $RELEASE_TAG"

          ASSET_COUNT=$(echo "$RELEASE_JSON" | jq '[.assets[] | select(.name | test("linux.*\\.tar\\.(xz|gz|zst|bz2)$"; "i"))] | length')
          if [[ "$ASSET_COUNT" -eq 0 ]]; then
            echo "No Linux tarball assets found in $RELEASE_TAG"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          IS_PRERELEASE=$(echo "$RELEASE_JSON" | jq -r '.prerelease // false')
          if [[ "$RELEASE_TAG" =~ (alpha|beta|rc|pre|preview|dev) ]]; then
            IS_PRERELEASE="true"
          fi

          HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${RELEASE_TAG}")

          if [[ "$HTTP_CODE" == "200" && "$FORCE_BUILD" != "true" ]]; then
            echo "Release $RELEASE_TAG already exists in our repo. Skipping."
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          CREATED_AT=$(echo "$RELEASE_JSON" | jq -r '.created_at // ""')
          if [[ -n "$CREATED_AT" && "$CREATED_AT" < "2025-01-01" ]]; then
            echo "Upstream release is too old: $CREATED_AT"
            echo "should_build=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "New version found: $RELEASE_TAG"
          echo "should_build=true" >> "$GITHUB_OUTPUT"
          echo "upstream_tag=$RELEASE_TAG" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "new_version=$(echo $RELEASE_TAG | sed 's/^v//')" >> "$GITHUB_OUTPUT"

      - name: Sync upstream metadata
        if: steps.check.outputs.should_build == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/*.sh
          ./scripts/sync-upstream.sh

  build:
    needs: check-and-build
    if: needs.check-and-build.outputs.should_build == 'true'
    runs-on: self-hosted
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    outputs:
      built: ${{ steps.build.outputs.built }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify build dependencies
        run: |
          set -euo pipefail
          deps=(
            ca-certificates curl jq git tar gzip xz bzip2 zstd
            ruby gcc make rpm dpkg dpkg-deb
          )
          for cmd in "${deps[@]}"; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
              echo "Missing dependency: $cmd"
              exit 1
            fi
          done
          if ! command -v fpm >/dev/null 2>&1; then
            echo "Missing dependency: fpm (gem install fpm)"
            exit 1
          fi

      - name: Build packages
        id: build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARCH_OVERRIDE: ${{ matrix.arch }}
        run: |
          chmod +x scripts/*.sh
          ./scripts/build.sh

          mkdir -p dist/${{ matrix.arch }}
          mv dist/*.deb dist/${{ matrix.arch }}/ 2>/dev/null || true
          mv dist/*.rpm dist/${{ matrix.arch }}/ 2>/dev/null || true
          mv dist/SHA256SUMS dist/${{ matrix.arch }}/ 2>/dev/null || true
          mv dist/meta.env dist/${{ matrix.arch }}/ 2>/dev/null || true
          mv dist/release_title.txt dist/${{ matrix.arch }}/ 2>/dev/null || true
          mv dist/release_notes.md dist/${{ matrix.arch }}/ 2>/dev/null || true

          if [[ -f "dist/${{ matrix.arch }}/meta.env" ]]; then
            source "dist/${{ matrix.arch }}/meta.env"
            if [[ "$SKIPPED" == "1" ]]; then
              echo "Build was skipped"
              echo "built=false" >> "$GITHUB_OUTPUT"
              exit 0
            fi
          fi

          if ls "dist/${{ matrix.arch }}"/*.deb 1>/dev/null 2>&1 && ls "dist/${{ matrix.arch }}"/*.rpm 1>/dev/null 2>&1; then
            echo "Packages built successfully"
            echo "built=true" >> "$GITHUB_OUTPUT"
          else
            echo "No packages found"
            echo "built=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Upload build artifacts
        if: steps.build.outputs.built == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          path: |
            dist/${{ matrix.arch }}/*.deb
            dist/${{ matrix.arch }}/*.rpm
            dist/${{ matrix.arch }}/SHA256SUMS
            dist/${{ matrix.arch }}/meta.env
            dist/${{ matrix.arch }}/release_title.txt
            dist/${{ matrix.arch }}/release_notes.md

  release:
    needs: [check-and-build, build]
    if: needs.check-and-build.outputs.should_build == 'true' && needs.build.result == 'success'
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify GitHub CLI
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            echo "Missing dependency: gh"
            exit 1
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Flatten artifacts
        run: |
          for arch in amd64 arm64; do
            if [[ -d "dist/$arch" ]]; then
              mv dist/$arch/* dist/ 2>/dev/null || true
            fi
          done

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          if [[ ! -f "dist/meta.env" ]]; then
            echo "No build artifacts found. Skipping release."
            exit 0
          fi

          source dist/meta.env
          RELEASE_TITLE=$(cat dist/release_title.txt 2>/dev/null || echo "$UPSTREAM_TAG")

          echo "Creating release: $UPSTREAM_TAG"

          if [[ "${IS_PRERELEASE:-false}" != "true" ]]; then
            echo "Cleaning up old pre-releases..."
            PRERELEASES=$(gh release list --limit 100 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName' || echo "")
            if [[ -n "$PRERELEASES" ]]; then
              echo "$PRERELEASES" | xargs -I {} gh release delete {} --yes --cleanup-tag 2>/dev/null || true
            fi
          fi

          if [[ "${IS_PRERELEASE:-false}" == "true" ]]; then
            gh release create "$UPSTREAM_TAG" \
              --title "$RELEASE_TITLE" \
              --notes-file dist/release_notes.md \
              --prerelease \
              dist/*.deb dist/*.rpm dist/SHA256SUMS
          else
            gh release create "$UPSTREAM_TAG" \
              --title "$RELEASE_TITLE" \
              --notes-file dist/release_notes.md \
              dist/*.deb dist/*.rpm dist/SHA256SUMS
          fi

          echo "Release created successfully: $UPSTREAM_TAG"

  deploy-repos:
    needs: [check-and-build, release]
    runs-on: self-hosted
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify repo build tools
        run: |
          set -euo pipefail
          for cmd in dpkg dpkg-deb createrepo_c; do
            if ! command -v "$cmd" >/dev/null 2>&1; then
              echo "Missing dependency: $cmd"
              exit 1
            fi
          done

      - name: Verify GitHub CLI
        run: |
          set -euo pipefail
          if ! command -v gh >/dev/null 2>&1; then
            echo "Missing dependency: gh"
            exit 1
          fi

      - name: Download packages from release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          rm -rf dist/*

          LATEST=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' 2>/dev/null || echo "")

          if [[ -n "$LATEST" && "$LATEST" != "null" ]]; then
            echo "Downloading packages from release: $LATEST"
            gh release download "$LATEST" --dir dist --pattern "*.deb" --pattern "*.rpm" || true
          fi

      - name: Clean old repo data
        run: |
          find repo -name "*.deb" -delete 2>/dev/null || true
          find repo -name "*.rpm" -delete 2>/dev/null || true
          rm -rf repo/apt/dists/* repo/apt/pool/* 2>/dev/null || true
          rm -rf repo/rpm/*/repodata repo/rpm/*/*.rpm 2>/dev/null || true

      - name: Generate APT repository
        run: |
          chmod +x scripts/*.sh
          ./scripts/generate-apt-repo.sh repo/apt

      - name: Generate RPM repository
        run: |
          ./scripts/generate-rpm-repo.sh repo/rpm

      - name: Copy install scripts
        run: |
          cp repo/install.sh repo/apt/ 2>/dev/null || true
          cp repo/install-rpm.sh repo/rpm/ 2>/dev/null || true

      - name: Update index page
        run: |
          if [[ -f "scripts/index.html.template" ]]; then
            cp -f scripts/index.html.template repo/index.html
          fi

      - name: Validate repositories
        run: |
          ./scripts/validate-repos.sh repo/apt repo/rpm

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: repo

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
