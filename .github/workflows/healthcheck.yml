name: Healthcheck and Auto-Repair

# Kas valanda tikrina ar APT/RPM repo veikia ir triggerinam rebuild jei sugedo
on:
  schedule:
    - cron: "30 * * * *"  # Kas valanda ties 30 min
  workflow_dispatch:

jobs:
  healthcheck:
    runs-on: ubuntu-slim
    permissions:
      actions: write
      contents: read
    outputs:
      healthy: ${{ steps.check.outputs.healthy }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Healthcheck repositories
        id: check
        env:
          OWNER: ${{ github.repository_owner }}
          REPO: ${{ github.event.repository.name }}
        run: |
          set -euo pipefail
          BASE="https://${OWNER}.github.io/${REPO}"
          echo "Checking: $BASE"

          check_url() {
            local url="$1"
            for i in 1 2 3; do
              HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" --max-time 30 "$url" 2>/dev/null || echo "000")
              if [[ "$HTTP_CODE" == "200" ]]; then
                echo "OK: $url"
                return 0
              fi
              sleep 3
            done
            echo "FAIL: $url (HTTP $HTTP_CODE)"
            return 1
          }

          FAIL=0
          
          # Core endpoints
          check_url "$BASE/index.html" || FAIL=1
          check_url "$BASE/install.sh" || FAIL=1
          check_url "$BASE/install-rpm.sh" || FAIL=1
          
          # APT repository
          check_url "$BASE/apt/dists/stable/Release" || FAIL=1
          check_url "$BASE/apt/dists/stable/main/binary-amd64/Packages.gz" || FAIL=1
          check_url "$BASE/apt/dists/stable/main/binary-arm64/Packages.gz" || FAIL=1
          
          # APT distribution aliases
          check_url "$BASE/apt/dists/noble/Release" || FAIL=1
          check_url "$BASE/apt/dists/jammy/Release" || FAIL=1
          
          # RPM repository
          check_url "$BASE/rpm/x86_64/repodata/repomd.xml" || FAIL=1
          check_url "$BASE/rpm/aarch64/repodata/repomd.xml" || FAIL=1

          if [[ "$FAIL" == "0" ]]; then
            echo "All healthchecks passed"
            echo "healthy=true" >> "$GITHUB_OUTPUT"
          else
            echo "Some healthchecks failed"
            echo "healthy=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Trigger rebuild if unhealthy
        if: failure()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Repositories are unhealthy. Triggering rebuild..."
          
          # Trigger the auto-build workflow
          curl -fsSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/actions/workflows/auto-build.yml/dispatches" \
            -d '{"ref":"main","inputs":{"force_build":"true"}}'
          
          echo "Rebuild triggered"
