name: Build DEB and RPM from upstream Tarball

on:
  workflow_dispatch:
  schedule:
    # daily
    - cron: '23 3 * * *'

permissions:
  contents: write

jobs:
  build-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dpkg-dev curl apt-utils ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Build packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/*.sh
          ./scripts/build.sh
          cat dist/meta.env

      - name: Create GitHub Release
        if: ${{ hashFiles('dist/*.deb') != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source dist/meta.env
          release_title="$(cat dist/release_title.txt)"
          rm -f dist/meta.env
          # In case dist/meta.env says SKIPPED=1, there should be no .deb; this step won't run.
          
          # Check if this should be a pre-release
          if [[ "${IS_PRERELEASE}" == "true" ]]; then
            gh release create "$UPSTREAM_TAG" \
              --title "$release_title" \
              --notes-file dist/release_notes.md \
              --prerelease \
              dist/*.deb dist/*.rpm dist/SHA256SUMS
          else
            # Before creating stable release, delete any existing pre-releases
            echo "Checking for pre-releases to delete..."
            prereleases=$(gh release list --limit 100 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName')
            if [[ -n "$prereleases" ]]; then
              echo "Found pre-releases to delete:"
              echo "$prereleases"
              echo "$prereleases" | xargs -I {} gh release delete {} --yes --cleanup-tag || true
            fi
            
            gh release create "$UPSTREAM_TAG" \
              --title "$release_title" \
              --notes-file dist/release_notes.md \
              dist/*.deb dist/*.rpm dist/SHA256SUMS
          fi
