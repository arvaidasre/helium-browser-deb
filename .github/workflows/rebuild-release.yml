name: Rebuild Release

# Allows rebuilding any existing or new version manually.
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g. 0.7.10.1 or 0.8.1.1)'
        required: true
        type: string
      replace_existing:
        description: 'Replace existing release if it exists'
        type: boolean
        default: true
      update_repos:
        description: 'Update APT/RPM repositories after build'
        type: boolean
        default: true
      arch:
        description: 'Which architecture to build'
        type: choice
        default: all
        options:
          - all
          - amd64
          - arm64

permissions:
  contents: write
  pages: write
  id-token: write

env:
  UPSTREAM_REPO: imputnet/helium-linux

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.validate.outputs.tag }}
      is_prerelease: ${{ steps.validate.outputs.is_prerelease }}
      release_exists: ${{ steps.validate.outputs.release_exists }}
    steps:
      - name: Validate version exists upstream
        id: validate
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          VERSION="${{ github.event.inputs.version }}"
          
          # Normalize version (remove 'v' prefix if present)
          TAG="${VERSION#v}"
          
          echo "Checking if version $TAG exists in upstream repo..."
          
          # Check if release exists upstream
          HTTP_CODE=$(curl -sS -o /tmp/release.json -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${UPSTREAM_REPO}/releases/tags/${TAG}")
          
          if [[ "$HTTP_CODE" != "200" ]]; then
            echo "::error::Version $TAG not found in upstream repository $UPSTREAM_REPO"
            exit 1
          fi
          
          # Check if it's a prerelease
          IS_PRERELEASE=$(jq -r '.prerelease // false' /tmp/release.json)
          if [[ "$TAG" =~ (alpha|beta|rc|pre|preview|dev) ]]; then
            IS_PRERELEASE="true"
          fi
          
          # Check if release exists in our repo
          OUR_HTTP_CODE=$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG}")
          
          if [[ "$OUR_HTTP_CODE" == "200" ]]; then
            RELEASE_EXISTS="true"
            echo "Release $TAG already exists in our repository"
          else
            RELEASE_EXISTS="false"
            echo "Release $TAG does not exist yet"
          fi
          
          # Check assets
          ASSET_COUNT=$(jq '[.assets[] | select(.name | test("linux.*\\.tar\\.(xz|gz|zst|bz2)$"; "i"))] | length' /tmp/release.json)
          if [[ "$ASSET_COUNT" -eq 0 ]]; then
            echo "::error::No Linux tarball assets found for version $TAG"
            exit 1
          fi
          
          echo "Version $TAG validated successfully"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "is_prerelease=$IS_PRERELEASE" >> "$GITHUB_OUTPUT"
          echo "release_exists=$RELEASE_EXISTS" >> "$GITHUB_OUTPUT"

  build:
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: ${{ fromJson(github.event.inputs.arch == 'all' && '["amd64","arm64"]' || format('["{0}"]', github.event.inputs.arch)) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dpkg-dev curl apt-utils ruby ruby-dev build-essential rpm createrepo-c
          sudo gem install fpm

      - name: Build packages
        id: build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ARCH_OVERRIDE: ${{ matrix.arch }}
          UPSTREAM_TAG: ${{ needs.validate.outputs.tag }}
        run: |
          chmod +x scripts/*/*.sh
          
          # Force build - ignore existing release check
          export FORCE_BUILD=true
          
          ./scripts/build/build.sh
          
          # Verify packages were created
          if ls dist/*.deb 1>/dev/null 2>&1 && ls dist/*.rpm 1>/dev/null 2>&1; then
            echo "Packages built successfully"
            echo "built=true" >> "$GITHUB_OUTPUT"
          else
            echo "No packages found"
            echo "built=false" >> "$GITHUB_OUTPUT"
            exit 1
          fi

      - name: Upload build artifacts
        if: steps.build.outputs.built == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: packages-${{ matrix.arch }}
          retention-days: 1
          path: |
            dist/*.deb
            dist/*.rpm
            dist/SHA256SUMS
            dist/meta.env
            dist/release_title.txt
            dist/release_notes.md

  release:
    needs: [validate, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist
          merge-multiple: true

      - name: Merge checksums
        run: |
          if ls dist/SHA256SUMS-* 1>/dev/null 2>&1; then
            cat dist/SHA256SUMS-* > dist/SHA256SUMS
            rm dist/SHA256SUMS-*
            echo "Merged checksums into dist/SHA256SUMS"
          fi

      - name: Delete existing release if requested
        if: needs.validate.outputs.release_exists == 'true' && github.event.inputs.replace_existing == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ needs.validate.outputs.tag }}"
          echo "Deleting existing release: $TAG"
          gh release delete "$TAG" --yes --cleanup-tag 2>/dev/null || true
          
          # Wait a moment for GitHub to process
          sleep 2

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          TAG="${{ needs.validate.outputs.tag }}"
          IS_PRERELEASE="${{ needs.validate.outputs.is_prerelease }}"
          
          if [[ ! -f "dist/meta.env" ]]; then
            echo "No build artifacts found"
            exit 1
          fi
          
          RELEASE_TITLE=$(cat dist/release_title.txt 2>/dev/null || echo "$TAG")
          
          echo "Creating release: $TAG"
          
          if [[ "$IS_PRERELEASE" == "true" ]]; then
            gh release create "$TAG" \
              --title "$RELEASE_TITLE" \
              --notes-file dist/release_notes.md \
              --prerelease \
              dist/*.deb dist/*.rpm dist/SHA256SUMS
          else
            gh release create "$TAG" \
              --title "$RELEASE_TITLE" \
              --notes-file dist/release_notes.md \
              dist/*.deb dist/*.rpm dist/SHA256SUMS
          fi
          
          echo "Release created successfully: $TAG"

  deploy-repos:
    needs: [validate, release]
    if: github.event.inputs.update_repos == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev createrepo-c jq

      - name: Download packages from releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mkdir -p dist
          rm -rf dist/*
          
          # Get latest stable release
          LATEST=$(gh api repos/${{ github.repository }}/releases/latest --jq '.tag_name' 2>/dev/null || echo "")
          
          if [[ -n "$LATEST" && "$LATEST" != "null" ]]; then
            echo "Downloading packages from stable release: $LATEST"
            gh release download "$LATEST" --dir dist --pattern "*.deb" --pattern "*.rpm" || true
          fi
          
          # Get latest pre-release (if exists and different from stable)
          PRERELEASE=$(gh api repos/${{ github.repository }}/releases --jq '[.[] | select(.prerelease == true)] | sort_by(.created_at) | last | .tag_name // ""' 2>/dev/null || echo "")
          
          if [[ -n "$PRERELEASE" && "$PRERELEASE" != "null" && "$PRERELEASE" != "$LATEST" ]]; then
            echo "Downloading packages from pre-release: $PRERELEASE"
            gh release download "$PRERELEASE" --dir dist --pattern "*.deb" --pattern "*.rpm" || true
          fi

      - name: Verify downloaded packages
        run: |
          ls -la dist
          if ! ls dist/*.deb >/dev/null 2>&1; then
            echo "No .deb packages downloaded" >&2
            exit 1
          fi
          if ! ls dist/*.rpm >/dev/null 2>&1; then
            echo "No .rpm packages downloaded" >&2
            exit 1
          fi

      - name: Build and publish repositories
        run: |
          chmod +x scripts/*/*.sh
          ./scripts/publish/publish.sh

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site/public

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
