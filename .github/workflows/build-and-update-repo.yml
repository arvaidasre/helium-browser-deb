name: Build and Update Repository

on:
  workflow_dispatch:
  schedule:
    # Daily at 3:00 AM UTC
    - cron: '0 3 * * *'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dpkg-dev curl apt-utils ruby ruby-dev build-essential rpm dpkg-scanpackages createrepo-c
          sudo gem install fpm

      - name: Build packages
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/*.sh
          
          # Get latest release info
          API_URL="https://api.github.com/repos/imputnet/helium-linux/releases/latest"
          JSON="$(curl -fsSL "$API_URL")"
          TAG="$(jq -r '.tag_name' <<<"$JSON")"
          
          if [[ "$TAG" == "null" || -z "$TAG" ]]; then
            echo "Could not determine tag name"
            exit 1
          fi
          
          # Check if release already exists
          HTTP_CODE="$(curl -sS -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}")"
          
          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "Release $TAG already exists. Downloading existing packages..."
            mkdir -p dist
            gh release download "$TAG" --dir dist --pattern "*.deb" --pattern "*.rpm" || true
          else
            echo "Building new packages for $TAG"
            ./scripts/build.sh
          fi
          
          # Save metadata
          cat > dist/meta.env <<EOF
          UPSTREAM_TAG=${TAG}
          UPSTREAM_VERSION=$(echo "$TAG" | sed 's/^v//')
          EOF

      - name: Generate APT repository
        run: |
          chmod +x scripts/*.sh
          ./scripts/generate-apt-repo.sh repo/apt

      - name: Generate RPM repository
        run: |
          chmod +x scripts/*.sh
          ./scripts/generate-rpm-repo.sh repo/rpm

      - name: Copy install scripts
        run: |
          cp repo/install.sh repo/apt/
          cp repo/install-rpm.sh repo/rpm/
          
      - name: Generate index page
        run: |
          mkdir -p repo
          rm -f repo/index.html
          if [ -f "scripts/index.html.template" ]; then
            cp -f scripts/index.html.template repo/index.html
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: repo

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
