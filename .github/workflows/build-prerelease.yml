name: Build Pre-release DEB and RPM from upstream Tarball

on:
  workflow_dispatch:
  schedule:
    # Check every 4 hours for pre-releases
    - cron: '0 */4 * * *'

permissions:
  contents: write

jobs:
  build-prerelease:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dpkg-dev curl apt-utils ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Check for pre-releases and build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Fetch latest release info
          echo "Fetching latest release info from imputnet/helium-linux..."
          API_URL="https://api.github.com/repos/imputnet/helium-linux/releases/latest"
          JSON="$(curl -fsSL "$API_URL")"
          
          TAG="$(jq -r '.tag_name' <<<"$JSON")"
          [[ "$TAG" == "null" || -z "$TAG" ]] && { echo "Could not determine tag name."; exit 1; }
          
          # Check if this is a pre-release
          PRERELEASE="$(jq -r '.prerelease // false' <<<"$JSON")"
          if [[ "$PRERELEASE" == "true" || "$TAG" =~ (alpha|beta|rc|pre|preview) ]]; then
            IS_PRERELEASE="true"
            echo "Detected pre-release: $TAG"
          else
            IS_PRERELEASE="false"
            echo "Latest release is not a pre-release: $TAG. Exiting."
            exit 0
          fi
          
          # Check if pre-release already exists
          if [[ -n "${GITHUB_TOKEN:-}" && -n "${GITHUB_REPOSITORY:-}" ]]; then
            echo "Checking if pre-release $TAG exists in $GITHUB_REPOSITORY..."
            HTTP_CODE="$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}")"
            
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Pre-release $TAG already exists. Skipping build."
              exit 0
            fi
          fi
          
          # Build the packages
          chmod +x scripts/*.sh
          ./scripts/build.sh
          
          # Verify we have packages
          if [[ ! -f dist/*.deb ]]; then
            echo "No DEB packages found. Exiting."
            exit 0
          fi
          
          # Create pre-release
          source dist/meta.env
          release_title="$(cat dist/release_title.txt)"
          rm -f dist/meta.env
          
          echo "Creating pre-release: $TAG"
          gh release create "$UPSTREAM_TAG" \
            --title "$release_title" \
            --notes-file dist/release_notes.md \
            --prerelease \
            --latest=false \
            dist/*.deb dist/*.rpm dist/SHA256SUMS
