name: Build Pre-release DEB and RPM from upstream Tarball

on:
  workflow_dispatch:
  schedule:
    # Check every 4 hours for pre-releases
    - cron: '0 */4 * * *'

permissions:
  contents: write

jobs:
  build-prerelease:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y jq dpkg-dev curl apt-utils ruby ruby-dev build-essential rpm
          sudo gem install fpm

      - name: Check for pre-releases and build
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Fetch all releases to find pre-releases
          echo "Fetching all releases from imputnet/helium-linux..."
          API_URL="https://api.github.com/repos/imputnet/helium-linux/releases"
          JSON="$(curl -fsSL "$API_URL")"
          
          # Find the latest pre-release
          LATEST_PRERELEASE="$(echo "$JSON" | jq -r '[.[] | select(.prerelease == true)][0]')"
          
          if [[ "$LATEST_PRERELEASE" == "null" || -z "$LATEST_PRERELEASE" ]]; then
            echo "No pre-releases found. Exiting."
            exit 0
          fi
          
          TAG="$(echo "$LATEST_PRERELEASE" | jq -r '.tag_name')"
          [[ "$TAG" == "null" || -z "$TAG" ]] && { echo "Could not determine tag name."; exit 1; }
          
          echo "Found latest pre-release: $TAG"
          
          # Check if pre-release already exists
          if [[ -n "${GITHUB_TOKEN:-}" && -n "${GITHUB_REPOSITORY:-}" ]]; then
            echo "Checking if pre-release $TAG exists in $GITHUB_REPOSITORY..."
            HTTP_CODE="$(curl -sS -o /dev/null -w "%{http_code}" \
              -H "Authorization: Bearer ${GITHUB_TOKEN}" \
              "https://api.github.com/repos/${GITHUB_REPOSITORY}/releases/tags/${TAG}")"
            
            if [[ "$HTTP_CODE" == "200" ]]; then
              echo "Pre-release $TAG already exists. Skipping build."
              exit 0
            fi
          fi
          
          # Build the pre-release packages
          echo "Building pre-release packages for tag: $TAG"
          chmod +x scripts/*.sh
          ./scripts/build-prerelease.sh "$TAG"
          
          # Verify we have packages
          if [[ ! -f dist/*.deb ]]; then
            echo "No DEB packages found. Exiting."
            exit 0
          fi
          
          # Create pre-release
          source dist/meta.env
          release_title="$(cat dist/release_title.txt)"
          rm -f dist/meta.env
          
          echo "Creating pre-release: $TAG"
          gh release create "$UPSTREAM_TAG" \
            --title "$release_title" \
            --notes-file dist/release_notes.md \
            --prerelease \
            --latest=false \
            dist/*.deb dist/*.rpm dist/SHA256SUMS
