name: Cleanup Old Releases

# Automatically deletes old releases weekly or can be run manually.
on:
  workflow_dispatch:
    inputs:
      keep_latest:
        description: 'Number of latest stable releases to keep'
        default: '5'
        required: true
      delete_prereleases:
        description: 'Delete all pre-releases'
        default: 'true'
        type: boolean
  schedule:
    # Every Sunday at 02:00 UTC
    - cron: '0 2 * * 0'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cleanup releases
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          
          # Default values (used when triggered by schedule)
          KEEP="${{ github.event.inputs.keep_latest }}"
          DELETE_PRE="${{ github.event.inputs.delete_prereleases }}"
          
          # If inputs are empty (schedule), use defaults
          [[ -z "$KEEP" ]] && KEEP="5"
          [[ -z "$DELETE_PRE" ]] && DELETE_PRE="true"
          
          # 1. Delete all pre-releases if requested
          if [[ "$DELETE_PRE" == "true" ]]; then
            echo "Checking for pre-releases to delete..."
            prereleases=$(gh release list --limit 100 --json tagName,isPrerelease --jq '.[] | select(.isPrerelease == true) | .tagName' || echo "")
            if [[ -n "$prereleases" ]]; then
              echo "Deleting pre-releases:"
              echo "$prereleases"
              echo "$prereleases" | xargs -I {} gh release delete {} --yes --cleanup-tag 2>/dev/null || true
            else
              echo "No pre-releases found."
            fi
          fi
          
          # 2. Delete old stable releases
          echo "Keeping latest $KEEP stable releases..."
          
          all_stable=$(gh release list --limit 100 --json tagName,isPrerelease,createdAt --jq '.[] | select(.isPrerelease == false) | .tagName' || echo "")
          
          if [[ -z "$all_stable" ]]; then
            echo "No stable releases found."
            exit 0
          fi
          
          count=$(echo "$all_stable" | wc -l)
          
          if [ "$count" -gt "$KEEP" ]; then
            to_delete=$(echo "$all_stable" | tail -n +$(($KEEP + 1)))
            echo "Deleting old stable releases:"
            echo "$to_delete"
            echo "$to_delete" | xargs -I {} gh release delete {} --yes --cleanup-tag 2>/dev/null || true
          else
            echo "Already have $count or fewer stable releases. Nothing to delete."
          fi
          
          echo "Cleanup completed successfully"

